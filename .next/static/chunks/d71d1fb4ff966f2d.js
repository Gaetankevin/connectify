(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,95872,e=>{"use strict";var t=e.i(43476),s=e.i(71645);async function r(e){let t=await fetch(`/api/users/search?q=${encodeURIComponent(e)}`,{credentials:"include"});if(!t.ok)throw Error("Failed to search users");return(await t.json()).users}async function a(){let e=await fetch("/api/conversations",{credentials:"include"});if(!e.ok)throw Error("Failed to fetch conversations");return(await e.json()).conversations}async function n(e){let t=await fetch("/api/conversations",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({otherUserId:e})});if(!t.ok)throw Error("Failed to create conversation");return t.json()}async function i(e){let t=await fetch(`/api/conversations/${e}`,{credentials:"include"});if(!t.ok)throw Error("Failed to fetch messages");return t.json()}async function o(e,t){let s;if(t.file){let r=new FormData;t.content&&r.append("content",t.content),r.append("file",t.file,t.file.name||"upload"),s=await fetch(`/api/conversations/${e}`,{method:"POST",credentials:"include",body:r})}else s=await fetch(`/api/conversations/${e}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw Error("Failed to send message");return s.json()}function l(){let[e,l]=(0,s.useState)([]),[d,c]=(0,s.useState)(null),[x,h]=(0,s.useState)([]),[m,u]=(0,s.useState)(null),[g,f]=(0,s.useState)(!1),[v,y]=(0,s.useState)(""),[j,p]=(0,s.useState)(""),[b,w]=(0,s.useState)([]),[N,k]=(0,s.useState)(""),[L,C]=(0,s.useState)(!0),[S,U]=(0,s.useState)(!1),[M,E]=(0,s.useState)(null),[W,T]=(0,s.useState)(!1),[F,B]=(0,s.useState)(null),[$,R]=(0,s.useState)(null),O=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=()=>{window.innerWidth>=768&&T(!1)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,s.useEffect)(()=>{z()},[]),(0,s.useEffect)(()=>{d&&D(d)},[d]),(0,s.useEffect)(()=>{O.current?.scrollIntoView({behavior:"smooth"})},[x]),(0,s.useEffect)(()=>{if(!F){$&&(URL.revokeObjectURL($),R(null));return}let e=URL.createObjectURL(F);return R(e),()=>{URL.revokeObjectURL(e),R(null)}},[F]);let z=async()=>{try{C(!0);let e=await a();l(e),e.length>0&&!d&&c(e[0].id)}catch(e){E("Failed to load conversations"),console.error(e)}finally{C(!1)}},D=async e=>{try{let{discussion:t,messages:s}=await i(e);u(t),h(s)}catch(e){E("Failed to load messages"),console.error(e)}},P=async e=>{if(e.length<2)return void w([]);try{let t=await r(e);w(t)}catch(e){console.error("Search failed:",e)}},A=async e=>{try{U(!0);let t=await n(e);await z(),c(t.id),f(!1),p(""),w([])}catch(e){E("Failed to create conversation"),console.error(e)}finally{U(!1)}},I=async e=>{if((e.preventDefault(),d&&!S)&&(N.trim()||F))try{U(!0);let e=await o(d,{content:N.trim()||void 0,file:F||void 0});h([...x,e]),k(""),B(null),await z()}catch(e){E("Failed to send message"),console.error(e)}finally{U(!1)}},K=e.filter(e=>e.otherUser.name.toLowerCase().includes(v.toLowerCase())||e.otherUser.username.toLowerCase().includes(v.toLowerCase())),q=e.find(e=>e.id===d),J=e=>{let t=new Date(e),s=new Date().getTime()-t.getTime(),r=Math.floor(s/6e4),a=Math.floor(s/36e5),n=Math.floor(s/864e5);return r<1?"now":r<60?`${r}m ago`:a<24?`${a}h ago`:n<7?`${n}d ago`:t.toLocaleDateString()};return(0,t.jsxs)("div",{className:"h-screen flex bg-gray-100 overflow-hidden",children:[(0,t.jsxs)("div",{className:"w-full md:w-64 bg-white border-r border-gray-200 overflow-y-auto flex flex-col",children:[(0,t.jsxs)("div",{className:"p-4 border-b border-gray-200",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,t.jsx)("h2",{className:"text-lg font-bold text-gray-900",children:"Messages"}),(0,t.jsx)("button",{onClick:()=>f(!0),className:"bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 transition",title:"New conversation",children:(0,t.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})})})]}),(0,t.jsx)("input",{type:"text",placeholder:"Search conversations...",value:v,onChange:e=>y(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto divide-y divide-gray-200",children:L?(0,t.jsx)("div",{className:"p-4 text-center text-gray-500",children:"Loading..."}):K.length>0?K.map(e=>(0,t.jsxs)("button",{onClick:()=>{c(e.id),window.innerWidth<768&&T(!0)},className:`w-full text-left px-4 py-3 transition ${d===e.id?"bg-indigo-50 border-l-4 border-indigo-600":"hover:bg-gray-50"}`,children:[(0,t.jsxs)("p",{className:"font-semibold text-gray-900 text-sm",children:[e.otherUser.name," ",e.otherUser.surname]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["@",e.otherUser.username]}),(0,t.jsx)("p",{className:"text-xs text-gray-600 truncate mt-1",children:e.lastMessage?.content||"No messages yet"}),(0,t.jsx)("p",{className:"text-xs text-gray-400 mt-1",children:e.lastMessage?J(e.lastMessage.createdAt):""})]},e.id)):(0,t.jsx)("div",{className:"p-4 text-center text-gray-500 text-sm",children:"No conversations found"})})]}),(0,t.jsx)("div",{className:`fixed inset-0 bg-black/50 z-30 md:hidden ${W?"block":"hidden"}`,onClick:()=>T(!1)}),(0,t.jsx)("div",{className:`transform transition-transform duration-300 ease-in-out bg-white z-40 flex flex-col h-full md:relative md:transform-none md:flex md:flex-1 ${W?"fixed inset-0 translate-x-0":"fixed inset-0 translate-x-full md:translate-x-0"}`,style:{},children:q&&m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"border-b border-gray-200 bg-white px-6 py-4 flex items-center justify-between",children:[(0,t.jsx)("div",{className:"flex items-center gap-3 md:hidden",children:(0,t.jsx)("button",{onClick:()=>T(!1),className:"p-2 rounded-md hover:bg-gray-100","aria-label":"Back to conversations",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-700",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})}),(0,t.jsxs)("div",{children:[(0,t.jsxs)("h3",{className:"text-lg font-semibold text-gray-900",children:[q.otherUser.name," ",q.otherUser.surname]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["@",q.otherUser.username]})]})]}),(0,t.jsxs)("div",{className:"flex-1 flex flex-col overflow-y-auto",children:[(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 space-y-4",children:[0===x.length?(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center text-center text-gray-500 py-8",children:(0,t.jsx)("p",{children:"Start the conversation!"})}):x.map(e=>(0,t.jsx)("div",{className:`flex ${e.senderId===q.otherUser.id?"justify-start":"justify-end"}`,children:(0,t.jsxs)("div",{className:`max-w-xs rounded-lg px-4 py-2 ${e.senderId===q.otherUser.id?"bg-gray-200 text-gray-900":"bg-indigo-600 text-white"}`,children:[e.content&&(0,t.jsx)("p",{className:"text-sm break-words",children:e.content}),e.mediaUrl&&(0,t.jsx)("div",{className:"mt-2",children:e.mediaType?.startsWith("image")?(0,t.jsx)("img",{src:e.mediaUrl,alt:"Message attachment",className:"max-w-xs rounded"}):(0,t.jsx)("a",{href:e.mediaUrl,target:"_blank",rel:"noopener noreferrer",className:"text-xs underline",children:"Download attachment"})}),(0,t.jsx)("p",{className:"text-xs mt-1 opacity-70",children:J(e.createdAt)})]})},e.id)),(0,t.jsx)("div",{ref:O})]}),(0,t.jsxs)("div",{className:"border-t border-gray-200 bg-white px-6 py-4",children:[M&&(0,t.jsx)("div",{className:"mb-3 p-2 bg-red-100 text-red-700 text-sm rounded",children:M}),F&&$&&(0,t.jsx)("div",{className:"mb-3",children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"max-w-xs max-h-48 overflow-hidden rounded",children:F.type.startsWith("image/")?(0,t.jsx)("img",{src:$,alt:"Preview",className:"object-cover w-48 h-32"}):F.type.startsWith("video/")?(0,t.jsx)("video",{src:$,controls:!0,className:"w-48 h-32 object-cover"}):(0,t.jsx)("div",{className:"w-48 h-32 flex items-center justify-center bg-gray-50 border rounded text-sm text-gray-600",children:(0,t.jsxs)("div",{className:"px-2 text-center",children:[(0,t.jsx)("div",{className:"font-semibold truncate",children:F.name}),(0,t.jsxs)("div",{className:"text-xs opacity-70",children:[(F.size/1024).toFixed(1)," KB"]})]})})}),(0,t.jsx)("div",{className:"flex-1",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("div",{className:"font-medium text-sm",children:F.name}),(0,t.jsx)("div",{className:"text-xs text-gray-500",children:F.type||"Unknown type"})]}),(0,t.jsx)("div",{children:(0,t.jsx)("button",{type:"button",onClick:()=>B(null),className:"text-sm text-gray-500 hover:text-gray-800",children:"Remove"})})]})})]})}),(0,t.jsxs)("form",{onSubmit:I,className:"flex items-center gap-3",children:[(0,t.jsx)("input",{type:"text",placeholder:"Type a message...",value:N,onChange:e=>k(e.target.value),disabled:S,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 disabled:bg-gray-100"}),(0,t.jsxs)("label",{className:"flex items-center gap-2",children:[(0,t.jsx)("input",{type:"file",accept:"image/*,video/*,application/pdf,application/*",onChange:e=>{B(e.target.files?.[0]||null)},className:"hidden"}),(0,t.jsx)("button",{type:"button",onClick:e=>{let t=e.currentTarget.closest("label")?.querySelector("input[type=file]");t?.click()},className:"p-2 rounded bg-gray-100 hover:bg-gray-200",title:"Attach file",children:(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-600",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.172 7l-6.586 6.586a2 2 0 102.828 2.828L18 9.828a4 4 0 10-5.656-5.656L6.343 10.172"})})})]}),(0,t.jsx)("button",{type:"submit","aria-label":S?"Envoi en cours":"Envoyer",title:S?"Envoi en cours":"Envoyer",disabled:S||!N.trim()&&!F,className:"bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 flex items-center justify-center",children:S?(0,t.jsxs)("svg",{className:"w-5 h-5 animate-spin",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0,children:[(0,t.jsx)("circle",{cx:"12",cy:"12",r:"10",stroke:"rgba(255,255,255,0.25)",strokeWidth:"4"}),(0,t.jsx)("path",{d:"M22 12a10 10 0 00-10-10",stroke:"white",strokeWidth:"4",strokeLinecap:"round"})]}):(0,t.jsxs)("svg",{className:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":!0,children:[(0,t.jsx)("path",{d:"M22 2L11 13",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,t.jsx)("path",{d:"M22 2l-7 20  -4-9-9-4 20-7z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",fill:"rgba(255,255,255,0.03)"})]})})]})]})]})]}):(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center text-center",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("svg",{className:"w-16 h-16 text-gray-300 mx-auto mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})}),(0,t.jsx)("p",{className:"text-gray-500 text-lg",children:L?"Loading...":"Select a conversation to start"})]})})}),g&&(0,t.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,t.jsxs)("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-md mx-4",children:[(0,t.jsxs)("div",{className:"border-b border-gray-200 px-6 py-4 flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:"Start New Conversation"}),(0,t.jsx)("button",{onClick:()=>{f(!1),p(""),w([])},className:"text-gray-400 hover:text-gray-600",children:(0,t.jsx)("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),(0,t.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,t.jsx)("input",{type:"text",placeholder:"Search by name or username...",value:j,onChange:e=>{p(e.target.value),P(e.target.value)},autoFocus:!0,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"})}),(0,t.jsx)("div",{className:"max-h-96 overflow-y-auto divide-y divide-gray-200",children:b.length>0?b.map(e=>(0,t.jsxs)("button",{onClick:()=>A(e.id),disabled:S,className:"w-full text-left px-6 py-4 hover:bg-gray-50 transition flex items-center justify-between disabled:opacity-50",children:[(0,t.jsxs)("div",{children:[(0,t.jsxs)("p",{className:"font-semibold text-gray-900 text-sm",children:[e.name," ",e.surname]}),(0,t.jsxs)("p",{className:"text-xs text-gray-500",children:["@",e.username]})]}),(0,t.jsx)("svg",{className:"w-5 h-5 text-gray-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,t.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})]},e.id)):j.length>0?(0,t.jsx)("div",{className:"p-6 text-center text-gray-500 text-sm",children:"No users found"}):(0,t.jsx)("div",{className:"p-6 text-center text-gray-500 text-sm",children:"Start typing to search users..."})})]})})]})}e.s(["default",()=>l],95872)}]);